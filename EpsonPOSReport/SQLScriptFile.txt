SELECT
	enVisionNumber.[enVision Number] AS [ResellerNo],
	customerNameTable.Extender_Key_Values_1 AS [ResellerName],
	partNumbers.[Ship To Customer] AS [EndUserName],
	invoiceNumbers.[Invoice Date] AS [InvDt],
	invoiceNumbers.[Invoice Number] AS [InvNo],
	partNumbers.ITEMNMBR AS [Part],
	partNumbers.ITMSHNAM AS [Item Number],
	serialNumberTable.CMMTTEXT AS [Serial Numbers],
	enVision.[enVision Status] AS [PgrmCd],
	partNumbers.QUANTITY AS [Units],
	partNumbers.UNITCOST AS [UnitCost],
	isnull(enVisionFulfillment.[enVision Rebate Amount], 0) AS [UnitRebate],
	isnull(partNumbers.UNITCOST - enVisionFulfillment.[enVision Rebate Amount], 0) AS [AdjUnitCost],
	isnull(enVisionFulfillment.[enVision Fulfillment Rate], 0) AS [FFUnitPcnt],
	isnull(partNumbers.UNITCOST * (enVisionFulfillment.[enVision Fulfillment Rate] / 100), 0) AS [FFUnitRebate],
	isnull(enVisionFulfillment.[enVision Rebate Amount] + (partNumbers.UNITCOST * (enVisionFulfillment.[enVision Fulfillment Rate] / 100)), 0) AS [TotalUnitRebate],
	isnull(partNumbers.QUANTITY * (enVisionFulfillment.[enVision Rebate Amount] + (partNumbers.UNITCOST * (enVisionFulfillment.[enVision Fulfillment Rate] / 100))), 0) AS [TotalExtRebate],
	enVision.[enVision Status],
	fulfillment.Fulfillment,
	fulfillmentPercent.[% Fulfillment]

	FROM
		(SELECT
			enVisionNumberTable.Extender_Record_ID,
			enVisionNumberTable.STRGA255 AS [enVision Number]
			From METRO.dbo.EXT01101 enVisionNumberTable
			where enVisionNumberTable.Field_ID = 240 AND enVisionNumberTable.STRGA255 <> '' AND enVisionNumberTable.STRGA255 <> 'RSLAVU'
		) enVisionNumber
		JOIN
			METRO.dbo.EXT01100 customerNameTable
			ON enVisionNumber.Extender_Record_ID = customerNameTable.Extender_Record_ID

			LEFT JOIN
				(SELECT 
					Extender_Record_ID,
					TOTAL AS [enVision Status]
					FROM METRO.dbo.EXT01103 WHERE Field_ID = 239) enVision
				ON enVision.Extender_Record_ID = enVisionNumber.Extender_Record_ID

			LEFT JOIN
				(SELECT
					Extender_Record_ID,
					TOTAL AS [Fulfillment]
					FROM METRO.dbo.EXT01103 WHERE Field_ID = 241) fulfillment
				ON fulfillment.Extender_Record_ID = enVisionNumber.Extender_Record_ID

			JOIN
				(SELECT
					Extender_Record_ID,
					TOTAL AS [% Fulfillment]
					FROM METRO.dbo.EXT01103 WHERE Field_ID = 242) fulfillmentPercent
				ON fulfillmentPercent.Extender_Record_ID = enVisionNumber.Extender_Record_ID

			LEFT JOIN
				(SELECT
					tHeader.SOPNUMBE AS [Invoice Number],
					tHeader.ACTLSHIP AS [Invoice Date],
					tHeader.CUSTNAME
					FROM METRO.dbo.SOP30200 tHeader WHERE MONTH(ACTLSHIP) = {0} AND YEAR(ACTLSHIP) = {1} AND SOPNUMBE like 'I%'
				) invoiceNumbers
				ON invoiceNumbers.CUSTNAME = customerNameTable.Extender_Key_Values_1

			LEFT JOIN
				(SELECT
					partTable.SOPNUMBE,
					partTable.LNITMSEQ,
					partTable.[Ship To Customer],
					partTable.UNITCOST,
					partTable.QUANTITY,
					cogsTable.ITEMNMBR,
					cogsTable.ITMSHNAM
					FROM 						
						(SELECT
							cogs.ITEMNMBR,
							cogs.ITMSHNAM
							FROM METRO.dbo.IV00101 cogs WHERE IVCOGSIX = 137 AND ITMSHNAM <> 'TM' AND ITMSHNAM <> 'Rebate'
						) cogsTable

						JOIN
							(SELECT
								parts.ITEMNMBR,
								parts.SOPNUMBE,
								parts.LNITMSEQ,
								parts.ShipToName AS [Ship To Customer],
								parts.UNITCOST,
								parts.QUANTITY
								FROM METRO.dbo.SOP30300 parts WHERE SOPNUMBE like 'I%'
							) partTable
						ON partTable.ITEMNMBR = cogsTable.ITEMNMBR
				) partNumbers
				ON partNumbers.SOPNUMBE = invoiceNumbers.[Invoice Number]

			LEFT JOIN
				(SELECT
					serialNumbers.LNITMSEQ,
					serialNumbers.SOPNUMBE,
					serialNumbers.CMMTTEXT
					FROM METRO.dbo.SOP10202 serialNumbers

				) serialNumberTable
				ON partNumbers.LNITMSEQ = serialNumberTable.LNITMSEQ AND partNumbers.SOPNUMBE = serialNumberTable.SOPNUMBE

			LEFT JOIN
				(SELECT
					enVisionPartNumbers.Extender_Record_ID,
					enVisionPartNumbers.Extender_Key_Values_1 AS [enVision Part Number],
					isEnVision.[Is enVision],
					enVisionRebateAmount.[enVision Rebate Amount],
					enVisionFulfillmentRate.[enVision Fulfillment Rate]
					
					FROM 
						(SELECT
							EXT01100.Extender_Record_ID,
							EXT01100.Extender_Key_Values_1
							FROM METRO.dbo.EXT01100 WHERE Extender_Window_ID = 'ITEM EXTRA'
						) enVisionPartNumbers

						LEFT JOIN
							(SELECT
								Extender_Record_ID,
								TOTAL AS [Is enVision]
								FROM METRO.dbo.EXT01103 WHERE Field_ID = 270
							) isEnVision
							ON isEnVision.Extender_Record_ID = enVisionPartNumbers.Extender_Record_ID
						LEFT JOIN
							(SELECT
								Extender_Record_ID,
								TOTAL AS [enVision Rebate Amount]
								FROM METRO.dbo.EXT01103 WHERE Field_ID = 271
							) enVisionRebateAmount
							ON enVisionRebateAmount.Extender_Record_ID = enVisionPartNumbers.Extender_Record_ID
						LEFT JOIN
							(SELECT
								Extender_Record_ID,
								TOTAL AS [enVision Fulfillment Rate]
								FROM METRO.dbo.EXT01103 WHERE Field_ID = 272
							) enVisionFulfillmentRate
							ON enVisionFulfillmentRate.Extender_Record_ID = enVisionPartNumbers.Extender_Record_ID
				) enVisionFulfillment
				ON enVisionFulfillment.[enVision Part Number] = partNumbers.ITEMNMBR

				WHERE partNumbers.ITEMNMBR IS NOT NULL